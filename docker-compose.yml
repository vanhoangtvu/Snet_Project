version: '3.8'

services:
  backend:
    build: ./backend
    container_name: pixshare-backend
    restart: always
    ports:
      - "0.0.0.0:${BACKEND_PORT:-8086}:8086"
    environment:
      # Connect to MySQL Server on host machine
      SPRING_DATASOURCE_URL: jdbc:mysql://host.docker.internal:3306/${MYSQL_DATABASE:-SNet_db}?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC&connectTimeout=300000&socketTimeout=600000
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_ROOT_PASSWORD:-1111}
      SERVER_ADDRESS: ${SERVER_ADDRESS:-0.0.0.0}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - pixshare-network
    volumes:
      - backend_uploads:/app/uploads

  frontend:
    build: ./frontend
    container_name: pixshare-frontend
    restart: always
    ports:
      - "0.0.0.0:${FRONTEND_PORT:-3006}:3006"
    environment:
      # API URL từ phía client browser - cấu hình trong .env.docker
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8086}
      NODE_ENV: production
    depends_on:
      - backend
    networks:
      - pixshare-network

volumes:
  backend_uploads:

networks:
  pixshare-network:
    driver: bridge
